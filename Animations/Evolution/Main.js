// ================================================
//               PLANS
// ================================================
/*

// SMALL FIXES
(*) Fix resize canvas
(*) Add smell (neighbor block fingerprint)
(*) Add attack visuals
(*) Add "sexually reproduce with neighbor" response
(*) Add thirst & drink properties
(*) Improve stats pane -- adujstable + noRedraw/storage needed
(*) Add modular digestion/response/sense -- can drink water? can consume meat? ...
(*) Add boid-response for sensing properties of boid -- direction + health + ...
(*) Connect color DNA to realistic sense data -- i.e. carnivorousity
(*) Add erode terrain button -- random droplets carry terrain down along gradients
(*) Add Swimming species
(*) Add jumping/flying
(*) Populate Introduction screen and make HTML
(*) Prettify CSS

*/

// ================================================
//               PARAMETERS
// ================================================


// globalDNA = [
  // 0: color 1
  // 1: color 2
  // 2: color 3
  // 3: maxHealth
  // 4: hasMemory (memoryBlocks if #>1)
  // 5: carnivorous
  // 6: senseLength
  // 7: FOV
  // 8: rays
  // 9: rayPoints
  //   Nx[a,b,c]: px responses
  //   layers
  //   stacks
  //   0,0,0,0,0,  0,0,0,0,0,  0,0,0,0,0,    1,0,0, 0,1,0, 0,0,1,   0,0,0, 0,0,0, 0,0,0, 0,0,0, 0,0,0
// ]
//
// globalDNA = [0.9616288754798882, 0, 0.015665259720376218, 0.9124127183036169, 0, 0, 0.07990297249368813, 0.1954313895425622, 0, 0.11971413992556096, 1, 1, 1, 0.2, 0.19899298944827024, -0.14249105234799497, 0.04685435165358848, -0.061907755285282966, 0.17205059778249843, -0.03158643984914481, -0.12598975966665138, -0.02934107536930332, 0.085990142156817, 0.048096712290814324, 0.03095519982653895, 0, -0.11044146281036966, -0.15957493259183692, -0.2777550970528103, -0.025252040966851824, 0.2340593545841449, 0.01670221323291264, 0.006691526902958808, -0.07406562148061091, 0.12722094366677478, 0.03568031698457904, 0.2976945320737261, 0.10343633614907094, -0.08488824949732444, -0.031009096063088895, -0.30199603393372854, 0.1589103626286364, 0.09081211581844112, -0.03929452580001902, 0.07119400431465198]

// globalDNA = [0.9216909190904393,0,0.015665259720376218,0.9246468140261541,0,0.030637637398325604,0.07990297249368813,0.1954313895425622,0,0.11971413992556096,1,1,1,0.2,0.19899298944827024,-0.048808430504438366,0.1635668157595962,0.16129113513354426,0.23401652393375985,0.019186511619659778,-0.6974197396062456,-0.7483696381338311,0.32062363349188716,-0.07124047576179335,-0.7863546422403145,0.018615313815713075,0.2839339042865573,0,-0.424606171027633,0,0.45419806539787444,0.01670221323291264,-0.05432766435979608,0.1689504965567116,0.13149283215397725,0.09626552101420993,0.6689964489270813,-1.262818652461625,0.5435054698031595,0.07611939460716174,-0.4167166963690287,0.3972091907639998,-0.22193993992681474,-0.026762109046724193,0.19783946613031708]

globalDNA = [1,0.06673766512992378,0.29840669481291393,0.9607899366770116,0.05835856311746976,0.006802484589704934,0,0.0765936903221241,0,0.21854226918295644,1,1,1,0.9798264650020222,1,1,0.5677733298340564,0.26212753761633656,-0.6809639226787026,0.41056034232046235,-0.3234154654799992,0.31667370132185124,1.594558153758907,0.11064791013416192,-1.2939067559930684,-0.5020655106311179,-0.10741753754463955,-0.24890725347407727,-1.0664072868514858,-0.5628803913015796,-0.21130542699308646,0.06475855435680693,0.9877529084083535,-1.2603912920769769,-0.8118962677743846,0,0,-1.2715617127108203,-0.1680972889073744,0,-0.14716235114411028,0,-0.8237767919026909,0.7650391266513554,-0.5994262501840802,-0.047793228506506226,0,0,-0.3466127632533323,1.0183709041349005,0.18594123785639,-0.3107172388816391,-0.768582442026822,0.8389196715438471,0,-0.08990828922702648,-0.3644114277819946,0,0.11580027625071443,0.008501224059669509,-0.6769224329315213,0,-0.4217186881981489,1.2221987904349836,0,0,0.5899404903037908,-0.7115441484440164,-0.8803189031987586,0,-0.1500909101607863,-0.04251320051500349,-0.10108114668124478,-0.09907473628724806,-0.3153104172331903,0.7686640082668318,0.8101901266866975,0.10104249124898657,0.23042075655728617,-1.595592414764615,0.08914572098984525,0,0.17174115795053607,0,-0.2401965068717389,0.2691485338595554,1.0516404828588592,-0.0040486092933360454,0.2840455757127778,0,0.6936818892308115,-0.6553725742710356,0.5289971493455041,0.3217672509415248,0.22143272817058574,0.15743679357857085,0,0.23862655645006725,0,-0.0737545207953549,0.13699598371044713,0.43411113818013825,-0.5682947303538828,0.04257397664708222,0,0,0.9599632568258323,0.7659830896846735,0,0.26790282334991017,0,1.6770744195825158,0.74690220669894,0,0.3484032768194031,0,0,0,0.28339025285125324,0,0,0.19393138728599024,0,-0.7992549128188248,0.08138986973949214,0.10027374447827074,0,-0.04923784335346816,0,-0.17895804912647595,0.4059699280886256,-0.019312637629880496,0.5742388270624236,-0.07821537415947441,-0.995905415174034,-0.30886265215986913,-0.4795497530195322,0.15035157116623168,0.02548757238964361,-0.12397375683696912,0.8635205472183531,-0.08509370697359257,0,0.24997372991167208,-0.6254688378100116,-0.153254319531544,1.4193897279657959,-0.941929543948641,1.095119715549627,-0.06551209679691572,-0.22427371098978996,0,-0.2057673662313661,0.5951143402053178,0.15492274605708917,-0.4733573694451808,0.09026834172250175,-0.35898315484591903,0.3223551027969615,0,0.16649613295041116,-0.13896091739736108,-0.3370494194939772,0.40812382012380466,-0.5225275575459487,-0.5347958464638988,-0.17189338992033787,0,-0.20033215416970326,0]

// 1,0.15859307632531344,0.020905579064664684,1,0.07113072164820017,0.2264956230485327,0.08909875681533977,0.11469914684834676,0,0.12104477173987019,1,1,1,0.33679154704886305,0.26212753761633656,1.175233958399513,0.5089558529230161,0.011259829267447619,0.6715600311254608,-1.0700179637523033,-0.5805653044242601,-0.38731182249025575,0.5263176007219998,-0.37378789514521876,-2.081289219930599,0.3496717638407191,-0.28050031103280615,-0.0997627348435108,-0.3762592363534304,0.9728784435146945,-0.1838040200325741,1.3569122251895447,-0.5301603172467066,-0.13746256470665102,1.1172357273932638,0,0,0,0,0,0.42544118833432487,-1.1907007198360962,-2.197246296518804,0.18533457340593892,0,-0.5433047791973054,0.42896429583522244,-1.3463327111578964,0.5945181159984688,0,-1.2857524308764976,-0.669429449180247,0.49991007181789615,0,-0.1890487639066229,-0.05808685571869378,-0.06415660790414969,0.37954366057350164,0.38967005672870647,0,0,0,0,0,0,1.4220084596474225,-1.6114486895857345,0.20547442668664762,-0.4073878276798892,0,-0.2747321311531938,0.11773865714400833,0.011726151642922414,0.031601490398875165,0,1.0576173828403501,-0.6659524432552669,0.6172919002968476,-0.30939717110422116,0,-0.2611702830712876,-0.6379839111952487,-0.03846567845586252,0.7863857028719267,0,-0.6599179201059953,1.6166776231624467,0.34067266207047114,-0.4712080021569103,0.4248749017558382

// 0.9572166160141474,0.15859307632531344,0.020905579064664684,1,0.07113072164820017,0.2264956230485327,0.08909875681533977,0.04131485735343135,0,0.12104477173987019,1,1,1,0.30727823838821267,0.26212753761633656,1.353005489009146,-0.05953854156887187,0.011259829267447619,0.6715600311254608,-1.0700179637523033,-0.5805653044242601,0.1131536625406857,0.5263176007219998,-0.37378789514521876,-2.081289219930599,-0.490109403708067,-0.02498123978220157,-0.002796187411624018,-0.7146687120508699,0.9728784435146945,-0.1838040200325741,0.4609481510655734,-0.5301603172467066,0.3486953828975205,1.1172357273932638,0.42544118833432487,-1.335039646327024,0.1102806347501411,-0.13664866719122595,-0.5433047791973054,0.42896429583522244,-1.0212419866290012,0.5945181159984688,-1.2857524308764976,-0.669429449180247,0.20285478631140064,0,0,-0.01545826421835439,0.31812456980722476,0.38967005672870647,1.4007453328732107,-1.6114486895857345,0.20547442668664762,-0.4073878276798892,-0.3655315497124884,-0.27169989999146527,0.13557402193987197,0.031601490398875165,1.0576173828403501,-0.5904024974584978,0.6172919002968476,0.017235904034000826,-0.2611702830712876,-0.7283147373624593,-0.03846567845586252,0.6893248045640281,-1.4034319591974127,1.4343022808271075,0.3553090745035951,-0.4712080021569103

// ------- GENERAL
var Nx        = 13*30;
var Ny        = 10*30;
var windowX   = Nx/4;
var windowY   = Ny/4;
var I         = 0;
var J         = 0;
var Screen    = "Information";

// ------- SPAWNING

// ------- ENVIRONMENT
var num                       = 55  // grass fertility noise
var falloff                   = 0.5 // grass fertility noise
var terrainScale              = 15
var terrainContrast           = 20.
var grassGrowth              = 0.01
var spreadGrowth             = 0.001
var grassFullLife            = 100
var grassThreshold            = 0.1
var grassEdibilityThreshold   = 0.001
var refillGrass               = false
var refillGrassNum            = 1


// ------- OBJECT
var healthLossPerTime     = 0.05;
var healthLossPerMove     = 0.5;
var healthLossPerBirth    = 0.4;
var healthLossPerAge      = 0.01;
var healthLossPerAttack   = 0.0;
var healthLossPerMaxHealth= 0.01;
var healthLossPerSense    = 0.0;
var waterDamage           = 10;
var healthGrainPerEat     = 50; // assuming fully grown grass
var maxHealth             = 500;
var boidRefillBarrier     = 50;
var attackHarm            = 400;
var carnivorousGain       = 8.5;
var DNAinfo = {
  "mutationProb"          : 1.0,
  "mutationSeverity"      : 0.05,
  "mutationProbPxResp"    : 0.,
  "mutationSeverityPxResp": 0.01
}

// ------- STATS
var STATS = {
  boidCount: 0,
  memoryCount: 0,
  carnivorousCount: 0,
  senseraySum: 0,
  layersSum: 0,
  stacksSum: 0
}
/*
  (a+b+c)/3
*/


// ------- BRAIN
var killAxonProb          = 0.1;
var mutation_m            = 0.1  // severity --> mutatable?
var mutation_p            = 5.5  // probability --> mutatable?
var changeStacksProb      = 0.6;
var changeStacksSev       = 0.1;
var changeLayersProb      = 0.2;
var changeLayersSev       = 0.01;

// ------- VISUAL
var showNeuronValue       = false;
var drawHealth            = false;
var drawSensedBlocks      = true;


// ------- EVENTS
var onclick = "DIG";

// ------- DUMMYs
var MATRIX,CONTROLPANEL,dx,dy;
var Cdirt1, Cdirt2, Cgrass1, Cgrass2, Cwater;
var bestBoid;


function setup(){
  createCanvas(windowWidth, windowHeight);
  windowY   = windowX*windowHeight/windowWidth;
  frameRate(100);
  initateScenario();
}


function initateScenario(){
  dx = width/windowX;
  dy = height/windowY;
  defineColors();
  MATRIX = new Matrix(Nx,Ny);
  MATRIX.initialize(num,falloff,0.01);
  CONTROLPANEL = new ControlPanel();
  CONTROLPANEL.assignPositions(80,20,20,15);
  CONTROLPANEL.hideAll();
  noStroke();
}


function draw(){
  if(CONTROLPANEL.PANELSELECT.value()=="Information"){
    STATS.boidCount = MATRIX.do();
    MATRIX.refill();
    CONTROLPANEL.updateValues();
    CONTROLPANEL.statisticsAccounting();
    background(0);
    noStroke();
    textSize(60);
    textAlign(CENTER);
    textSize(60);fill(Cwater);
    text("EVOLUTION",width/2,height/4)
    textSize(14);fill(255);
    text("Welcome! In the 'Animation' screen, you can monitor the behaviour \n of the species that have evolved as they navigate the terrain. Each of \n these creatures have a unique brain. The brain of best creature \n (according to some arbitrary metric) is displayed in the \n 'Brain dynamics' screen. In the 'Controlpanel' screen \n you can adjust parameters for the terrain, creature mutation \n and creature health. If you press 'space' a DNA strand will appear \n in the control panel. Any valid DNA strand \n can be copied into the input box. Choosing the 'makeboid' option \n in the controlpanel then allows you (when in the animation screen) \n to place this creature in the terrain.   ",width/2,height/4+50)
    textSize(12); textAlign(LEFT);
  }else if(CONTROLPANEL.PANELSELECT.value()=="Animation"){
    background(Cdirt2)
    strokeWeight(1);
    noStroke();
    // MATRIX.display(I,J,windowX,windowY);
    MATRIX.displayBackground(I,J,windowX,windowY);
    MATRIX.displayToplayer(I,J,windowX,windowY);
    STATS.boidCount = MATRIX.do();
    MATRIX.refill();
    CONTROLPANEL.statisticsAccounting()
    fill(255);
    text(bestBoid.age, 10, 30);
    text(STATS.boidCount, 10, 40);
    text(boidRefillBarrier,10,60);
  }else if(CONTROLPANEL.PANELSELECT.value()=="Brain dynamics"){
    STATS.boidCount = MATRIX.do();
    MATRIX.refill();
    background(0);
    translate(0.1*width, 0.1*height);
    var sx = min(0.8*width/(bestBoid.BRAIN.layers+2),width/7);
    var sy = 0.8*height/max(bestBoid.BRAIN.stacks,bestBoid.BRAIN.inputs,bestBoid.BRAIN.outputs)
    bestBoid.BRAIN.display(sx,sy);
    CONTROLPANEL.statisticsAccounting()
    fill(255);
    text(bestBoid.age, -50, 30);
    text(STATS.boidCount, -50, 40);
    text(boidRefillBarrier,-50,50);
  }else if(CONTROLPANEL.PANELSELECT.value()=="Controlpanel"){
    background(255);
    STATS.boidCount = MATRIX.do();
    MATRIX.refill();
    CONTROLPANEL.updateValues();
    CONTROLPANEL.statisticsAccounting()
    CONTROLPANEL.display(80+140,20,20,15);
    fill(255,0,0)
    text(STATS.boidCount, width-50, height-50);
  }else if(CONTROLPANEL.PANELSELECT.value()=="Statistics"){
    background(255);
    STATS.boidCount = MATRIX.do();
    MATRIX.refill();
    CONTROLPANEL.statisticsAccounting()
    drawGraph(CONTROLPANEL.STATISTICS)
  }

  if(CONTROLPANEL.PANELSELECT.value()!=Screen){
    if(CONTROLPANEL.PANELSELECT.value()=="Controlpanel"){
      CONTROLPANEL.showAll();
    }else{
      CONTROLPANEL.hideAll();
    }
    Screen = CONTROLPANEL.PANELSELECT.value()
  }

  // refillProbability
}


// GOOD DNA:
// 0.9145546261681798,0.020360855367930614,0.02480404618405932,0.9511804034053324,0,0.040938379452995194,0.12497755616313726,0.23111426651593933,0,0.16480059747790007,1,0.9536931539253147,1,0.28157998506229653,0.19899298944827024,-0.4783417480284491,0.6024136277854235,-0.08371740811939846,0.6076495448738523,0.9279053222159347,-0.1477405434550555,-0.03400815374732763,-0.09668985406511124,-0.14288901360116124,0.2359263281559183,-0.1642279884431649,-0.10982037147252122,-0.5437387418959092,-0.8371380750418582,-0.712300460639887,-0.20505444883120041,0,0.45841960958404937,-0.06468967079759902,-0.0295657392460809,0.2123654153034038,-0.2197816450165529,-0.021756237745751375,-0.018660290532103788,0.05802734914795066,0.05587159362002678,-0.5263030612821606,-0.0008652258622784403,0.3314910105699509,0.13687412079776468,-1.281811442744075,-0.16499490241037934,-0.03791331005265301,-0.3110149242781332,0.27440746629656826,-0.13790701133281064,0.20085890577132715,0.037099163450279526,0.20764713926753844,0

// 0.9026990751568944,0,0.03959308827432221,0.9106228622728454,0.01758090473390113,0.0013295130905739694,0.07048820465800715,0.2580085654298727,0.02325487724796675,0.14823150729838286,1,0.9632125256879858,1,0.2634645866066674,0.19703155395446967,-0.2743545918267417,0.4274984196828041,-0.08371740811939846,0.6743300647311541,0.8462353806237719,-0.10509023278875895,-0.08909706356977962,-0.15136653320980567,-0.1744220739667374,0.23098588700152195,-0.11191034961421907,-0.04820582370015296,-0.5550348851312439,-0.7263943917950393,-0.7311021019184747,0.13167090447220256,-0.28871259890641116,-0.07201937240864834,0.14679945307554104,-0.009556812566049525,-0.41410888522383327,0.4650887884568833,0.0826077725927762,-1.254508194147606,-0.10994816437166857,-0.3224371141393709,0.20044971609857706,0.1944867888247085,-0.020546675145016388,0.16569183598797288

// 0.8924518429844038,0.011425525724266958,0.07349580336231322,0.917846882317479,0,0.0013295130905739694,0.07048820465800715,0.2580085654298727,0.02325487724796675,0.14823150729838286,1,0.9632125256879858,1,0.2634645866066674,0.19899298944827024,-0.4944988660574199,0.4274984196828041,-0.15403665452282922,0,0.8771152797050517,-0.1477405434550555,-0.08909706356977962,-0.1935628933600571,-0.1750476024175939,0.2831966085289176,-0.21630821583880347,-0.15557941205882464,-0.5898407296610179,-0.7263943917950393,-0.8006138640989391,0.15662651937451155,-0.24803517506604664,-0.1522897234701083,-0.03893603042639104,-0.09147615029908457,-0.4169586823187362,0.46500348971068933,0.0826077725927762,-1.3184940688796507,0.025043728664573897,-0.3501405463409786,0.35495305936137145,0.2109377492482498,-0.10635523820140437,0.24610656463421932
